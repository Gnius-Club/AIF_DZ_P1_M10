<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>La Red de los Corazones Conectados</title>
  <style>
    /* =============================================================
       ESTILOS GENERALES (Alto contraste + tipografÃ­as legibles)
       ============================================================= */
    :root{
      --bg: #0b1221;           /* Fondo oscuro espacial */
      --panel: #0f1b39;        /* Paneles */
      --text: #ffffff;         /* Texto alto contraste */
      --accent: #35e0ff;       /* Cian neÃ³n */
      --accent2: #ff71d4;      /* Rosa neÃ³n */
      --success: #29e07a;      /* Verde Ã©xito */
      --warn: #ffb84d;         /* Ãmbar para hints */
      --error: #ff5a5a;        /* Rojo error */
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 80% -10%, #14244f 0%, var(--bg) 55%) no-repeat, var(--bg);
      color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overflow:hidden;
    }

    /* Contenedor principal responsivo */
    .wrap{position:relative; height:100%; width:100%;}

    /* Botones accesibles */
    button, .btn{
      background:linear-gradient(180deg, var(--accent), #1ea4b8);
      color:#001318; border:none; border-radius:14px; padding:12px 16px; font-size:1rem; font-weight:700; cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.4), inset 0 0 0 2px rgba(255,255,255,.15);
    }
    button:focus-visible{outline:3px solid #fff; outline-offset:2px}
    .btn.secondary{background:linear-gradient(180deg, var(--accent2), #a93c89); color:#19000f}
    .btn.ghost{background:transparent; border:2px solid var(--accent); color:var(--accent)}

    /* Panel superior con accesibilidad y estado */
    .hud{
      position:absolute; inset:0 auto auto 0; right:0; height:64px; display:flex; align-items:center; gap:10px; padding:8px 12px; z-index:30;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.1)); backdrop-filter: blur(6px);
    }
    .hud > *{display:flex; align-items:center; gap:8px}
    .badge{background:var(--panel); padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12)}
    .progress{height:12px; width:160px; background:#122041; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.15)}
    .progress > i{display:block; height:100%; width:0; background: linear-gradient(90deg, var(--success), #94ffd1)}

    /* Escenas / pantallas */
    .scene{position:absolute; inset:0; display:none}
    .scene.active{display:block}

    /* Estrellas decorativas */
    .stars{position:absolute; inset:0; pointer-events:none; background-image: radial-gradient(#fff, rgba(255,255,255,0) 60%);
      background-size:2px 2px; opacity:.35; mask-image: radial-gradient(1000px 600px at 50% 50%, #000 50%, transparent 100%);
    }

    /* OBSERVATORIO (IntroducciÃ³n) */
    .observatorio{display:grid; grid-template-columns: 1.2fr 1fr; gap:18px; height:100%; padding:24px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:18px; box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .title{font-size:clamp(22px, 3vw, 34px); font-weight:900; letter-spacing:.4px}
    .subtitle{opacity:.8}
    .demo-net{height:100%; border-radius:16px; position:relative; overflow:hidden}
    .demo-net svg{position:absolute; inset:0; width:100%; height:100%}

    /* MAPA GALÃCTICO */
    .mapa{position:absolute; inset:0;}
    .canvas{position:absolute; inset:0}
    svg.lines{position:absolute; inset:0; width:100%; height:100%; pointer-events:none}
    .planeta{position:absolute; width:90px; height:90px; border-radius:999px; background: radial-gradient(circle at 35% 30%, #fff8 0%, #ffffff10 50%, #00000055 100%),
      linear-gradient(180deg, #2853ff, #6e2eff);
      border:2px solid rgba(255,255,255,.25); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.55), inset 0 0 22px rgba(255,255,255,.18);
      transition: transform .2s ease;
    }
    .planeta:focus-visible{outline:3px solid #fff}
    .planeta .avatar{font-size:30px}
    .planeta .name{font-size:.85rem; font-weight:800; text-shadow:0 2px 6px rgba(0,0,0,.6)}
    .planeta .need{font-size:22px}
    .planeta .meter{position:absolute; bottom:-8px; left:50%; transform:translateX(-50%); width:86px; height:10px; background:#0d1430; border:1px solid rgba(255,255,255,.2); border-radius:999px; overflow:hidden}
    .planeta .meter i{display:block; height:100%; width:0; background: linear-gradient(90deg, #ff9bbb, #ff3a86)}
    .planeta.selected{transform:scale(1.08)}
    .planeta.hint{box-shadow: 0 0 0 2px var(--warn), 0 10px 24px rgba(0,0,0,.55)}

    /* Indicadores e iconos grandes */
    .legend{position:absolute; left:12px; bottom:12px; display:flex; gap:8px; flex-wrap:wrap; max-width:min(95vw, 800px);}
    .legend .legend-item{background:rgba(0,0,0,.45); padding:8px 10px; border:1px solid rgba(255,255,255,.15); border-radius:12px; font-size:.95rem}

    /* Pantalla final */
    .final{display:grid; place-items:center; text-align:center; padding:24px}
    .final .net{width:min(900px, 92vw); height:60vh; border-radius:18px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.15); position:relative; overflow:hidden}
    .final h1{font-size:clamp(26px, 4.5vw, 44px)}

    /* Controles de accesibilidad */
    .a11y{margin-left:auto}
    .toggle{display:flex; gap:6px; align-items:center}
    .toggle input{width:44px; height:24px}

    /* MÃ³vil: layout intro a una columna */
    @media (max-width: 900px){
      .observatorio{grid-template-columns:1fr; padding-bottom:100px}
      .hud{height:auto; flex-wrap:wrap; justify-content:center; gap:8px}
      .planeta{width:76px; height:76px}
      .planeta .avatar{font-size:26px}
      .planeta .name{font-size:.8rem}
      .planeta .need{font-size:18px}
      .planeta .meter{width:72px}
    }
  </style>
</head>
<body>
<div class="wrap" aria-live="polite">
  <!-- HUD superior: progreso, galaxia, accesibilidad -->
  <div class="hud" role="region" aria-label="Barra de estado y accesibilidad">
    <div class="badge" title="Conexiones completadas" aria-label="Conexiones completadas">
      â­ Progreso
      <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>
      <span id="progressText" style="font-weight:800">0/0</span>
    </div>

    <div class="badge" aria-label="Galaxia actual">
      ğŸŒŒ <span id="galaxyName">Galaxia 1</span>
    </div>

    <div class="badge a11y">
      <div class="toggle" title="NarraciÃ³n por voz">
        <label for="voiceToggle">ğŸ”Š NarraciÃ³n</label>
        <input id="voiceToggle" type="checkbox" aria-label="Activar o desactivar narraciÃ³n" checked />
      </div>
      <div class="toggle" title="Sonidos del juego">
        <label for="soundToggle">ğŸµ Sonidos</label>
        <input id="soundToggle" type="checkbox" aria-label="Activar o desactivar sonidos" checked />
      </div>
      <button class="btn ghost" id="btnAlbum" aria-label="Abrir Ã¡lbum de momentos conectados">ğŸ“¸ Ãlbum</button>
    </div>
  </div>

  <!-- Estrellas decorativas -->
  <div class="stars"></div>

  <!-- =====================
       PANTALLA: INTRO
       ===================== -->
  <section id="screenIntro" class="scene active" aria-label="Observatorio CÃ³smico">
    <div class="observatorio">
      <div class="card" role="dialog" aria-labelledby="introTitle" aria-describedby="introDesc">
        <div class="title" id="introTitle">ğŸ›°ï¸ Observatorio CÃ³smico</div>
        <p class="subtitle" id="introDesc">
          Bienvenid@, explorador@. Soy la <strong>GuÃ­a de la Galaxia</strong>. Hoy aprenderÃ¡s que Internet es una <strong>red</strong> que conecta personas y cosas para <em>compartir ideas, juegos y mensajes</em>.
        </p>
        <ol>
          <li><strong>Concepto de Red:</strong> Conecta dos planetas con un hilo para formar una red.</li>
          <li><strong>Internet como Comunidad:</strong> Los habitantes conectados pueden saludarse y colaborar.</li>
          <li><strong>Juegos, Ideas y Mensajes:</strong> VerÃ¡s iconos viajando por los hilos cuando crees conexiones.</li>
        </ol>
        <p><strong>Mensaje:</strong> â€œEscucha las necesidades de cada habitante y conecta a las personas adecuadas para ayudarlasâ€.</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="btnStart">Â¡Comenzar MisiÃ³n!</button>
          <button class="btn secondary" id="btnNarrarIntro">ğŸ”Š Escuchar Briefing</button>
        </div>
      </div>

      <!-- Mini demostraciÃ³n de red animada (SVG) -->
      <div class="demo-net card" aria-hidden="true">
        <svg id="demoSvg" viewBox="0 0 600 380" preserveAspectRatio="xMidYMid slice">
          <defs>
            <filter id="glow"><feGaussianBlur stdDeviation="2.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>
          <g id="demoNodes" fill="#fff">
            <circle cx="100" cy="70" r="14" fill="#6cf"/>
            <circle cx="250" cy="120" r="14" fill="#f6c"/>
            <circle cx="420" cy="80" r="14" fill="#fc6"/>
            <circle cx="160" cy="280" r="14" fill="#9f6"/>
            <circle cx="520" cy="260" r="14" fill="#6ff"/>
          </g>
          <g id="demoLines" stroke="#9cf" stroke-width="3" stroke-linecap="round" filter="url(#glow)"></g>
          <g id="demoFlow" font-size="18"><text x="0" y="0">ğŸ®</text><text x="0" y="0">ğŸ’¡</text><text x="0" y="0">âœ‰ï¸</text></g>
        </svg>
      </div>
    </div>
  </section>

  <!-- =====================
       PANTALLA: JUEGO
       ===================== -->
  <section id="screenGame" class="scene" aria-label="Mapa estelar interactivo">
    <div class="mapa" id="mapa">
      <!-- SVG para lÃ­neas -->
      <svg class="lines" id="lines" viewBox="0 0 1000 700" preserveAspectRatio="none" aria-hidden="true"></svg>
      <!-- Planetas se inyectan dinÃ¡micamente como divs .planeta -->
      <div class="legend" aria-label="Leyenda de iconos">
        <div class="legend-item">ğŸ® Juegos</div>
        <div class="legend-item">ğŸ’¡ Clase / Ideas</div>
        <div class="legend-item">âœ‰ï¸ Mensajes / Videollamada</div>
        <div class="legend-item">ğŸ¸ MÃºsica</div>
        <div class="legend-item">ğŸ‚ Pastel</div>
        <div class="legend-item">ğŸˆ Decoraciones</div>
      </div>
    </div>
  </section>

  <!-- =====================
       PANTALLA: FINAL
       ===================== -->
  <section id="screenFinal" class="scene final" aria-label="Red completa formada">
    <div>
      <h1>âœ¨ Â¡MisiÃ³n cumplida! Â¡La red de corazones brilla en toda la galaxia! âœ¨</h1>
      <p id="finalPhrase" style="opacity:.9; max-width:840px; margin:0 auto 12px">Has conectado a familias, jugadores, estudiantes y amig@s. Internet es una comunidad para <strong>interactuar</strong>, <strong>colaborar</strong> y <strong>compartir</strong>.</p>
      <div class="net" id="finalNet" aria-hidden="true"></div>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:14px">
        <button class="btn" id="btnNextGalaxy">ğŸš€ Desbloquear nueva galaxia</button>
        <button class="btn ghost" id="btnReplay">ğŸ” Volver a jugar</button>
      </div>
    </div>
  </section>
</div>

<!-- =============================
     LÃ“GICA DEL JUEGO (JavaScript)
     ============================= -->
<script>
/*
  =============================================
  ARQUITECTURA DEL JUEGO
  ---------------------------------------------
  - Pantalla de introducciÃ³n con narraciÃ³n (SpeechSynthesis).
  - Pantalla de mapa estelar: planetas (nodos) y lÃ­neas (aristas) en SVG.
  - MecÃ¡nica: seleccionar un planeta (origen) y luego un objetivo compatible.
  - Conexiones especiales:
      * 1 a 1 (Videollamada Familiar, Partida de Videojuegos)
      * 1 a muchos (Clase Virtual)
      * muchos a 1 (Fiesta Sorpresa)
  - Barras de felicidad por planeta y barra global de progreso.
  - Sonidos con WebAudio (Ã©xito, error, especial).
  - Rejugabilidad: desbloqueo de segunda galaxia + Ãlbum de Momentos en localStorage.
  - Accesibilidad: texto legible, alto contraste, grandes iconos, controles de audio, narraciÃ³n activable.
*/

/*********************** UTILIDADES AUDIO ************************/
const AudioKit = (()=>{
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let enabled = true;
  const setEnabled = v=> enabled = v;
  function beep({type="sine", freq=440, dur=0.18, gain=0.12}){
    if(!enabled) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime+dur);
  }
  function chordSuccess(){
    beep({type:"triangle", freq:740, dur:.12});
    setTimeout(()=>beep({type:"triangle", freq:880, dur:.18}), 110);
    setTimeout(()=>beep({type:"sine", freq:1175, dur:.22}), 220);
  }
  function softError(){
    beep({type:"sawtooth", freq:220, dur:.12, gain:.09});
    setTimeout(()=>beep({type:"sawtooth", freq:180, dur:.16, gain:.08}), 120);
  }
  function sparkle(){
    [1320,1760,2340].forEach((f,i)=> setTimeout(()=> beep({type:"square", freq:f, dur:.08}), i*90));
  }
  return {chordSuccess, softError, sparkle, setEnabled};
})();

/*********************** NARRACIÃ“N ************************/
const Narrator = (()=>{
  let enabled = true;
  const setEnabled = v=> enabled = v;
  function speak(text){
    if(!enabled) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "es-MX";
    u.rate = 1.0; u.pitch = 1.02;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }
  return {speak, setEnabled};
})();

/*********************** DATOS DE GALAXIAS ************************/
// Definimos dos galaxias (niveles). Cada planeta tiene:
// id, nombre, emoji avatar, rol, tags de compatibilidad, tipo de necesidad y reglas.

const GALAXIES = [
  {
    name: "Galaxia 1",
    width: 1000, height: 700,
    nodes: [
      {id:"anita", name:"Anita", avatar:"ğŸ§‘â€ğŸš€", need:"âœ‰ï¸", role:"persona", tags:["familia"], x:120,y:140},
      {id:"abu", name:"Abuela", avatar:"ğŸ‘µ", need:"âœ‰ï¸", role:"persona", tags:["familia"], x:300,y:100},

      {id:"paco", name:"Paco", avatar:"ğŸ§‘", need:"ğŸ®", role:"persona", tags:["juegos"], x:140,y:480},
      {id:"lola", name:"Lola", avatar:"ğŸ‘§", need:"ğŸ®", role:"persona", tags:["juegos"], x:360,y:520},

      {id:"profe", name:"Maestro", avatar:"ğŸ§‘â€ğŸ«", need:"ğŸ’¡", role:"maestro", tags:["dino"], x:720,y:140},
      {id:"nina1", name:"Sofi", avatar:"ğŸ§’", need:"ğŸ’¡", role:"alumno", tags:["dino"], x:860,y:260},
      {id:"nino2", name:"Timo", avatar:"ğŸ‘¦", need:"ğŸ’¡", role:"alumno", tags:["dino"], x:640,y:280},
      {id:"nina3", name:"Mia", avatar:"ğŸ‘§", need:"ğŸ’¡", role:"alumno", tags:["dino"], x:820,y:380},

      {id:"leo", name:"Leo", avatar:"ğŸ§‘â€ğŸš€", need:"âœ¨", role:"cumple", tags:["fiesta"], x:520,y:420},
      {id:"rita", name:"Rita", avatar:"ğŸ§‘â€ğŸ¤", need:"ğŸ¸", role:"musica", tags:["fiesta"], x:620,y:540},
      {id:"tomas", name:"TomÃ¡s", avatar:"ğŸ§‘â€ğŸ³", need:"ğŸ‚", role:"pastel", tags:["fiesta"], x:520,y:620},
      {id:"sara", name:"Sara", avatar:"ğŸ§‘", need:"ğŸˆ", role:"deco", tags:["fiesta"], x:740,y:500}
    ],
    goals:[
      {id:"videollamada", type:"oneToOne", a:"anita", b:"abu", icon:"âœ‰ï¸", announce:"Familia: Â¡La red acorta la distancia, y nos une en la misma estancia!"},
      {id:"gamers", type:"oneToOne", a:"paco", b:"lola", icon:"ğŸ®", announce:"Jugadores: Â¡Con un simple clic, la diversiÃ³n hace un tic!"},
      {id:"clase", type:"oneToMany", a:"profe", bs:["nina1","nino2","nina3"], icon:"ğŸ’¡", announce:"Clase Virtual conectada: Â¡conocimiento que viaja por la red!"},
      {id:"fiesta", type:"manyToOne", bs:["rita","tomas","sara"], a:"leo", icon:"âœ¨", announce:"Â¡Fiesta sorpresa lista! Leo vuelve a sonreÃ­r."}
    ]
  },
  {
    name: "Galaxia 2",
    width: 1000, height: 700,
    nodes: [
      {id:"ana2", name:"Ana", avatar:"ğŸ§‘â€ğŸš€", need:"âœ‰ï¸", role:"persona", tags:["familia"], x:140,y:160},
      {id:"tia2", name:"TÃ­a", avatar:"ğŸ‘©", need:"âœ‰ï¸", role:"persona", tags:["familia"], x:320,y:80},
      {id:"gamer1", name:"Kai", avatar:"ğŸ‘¦", need:"ğŸ®", role:"persona", tags:["juegos"], x:220,y:520},
      {id:"gamer2", name:"Nora", avatar:"ğŸ‘§", need:"ğŸ®", role:"persona", tags:["juegos"], x:420,y:560},
      {id:"profe2", name:"Maestra", avatar:"ğŸ‘©â€ğŸ«", need:"ğŸ’¡", role:"maestro", tags:["arte"], x:700,y:160},
      {id:"al1", name:"Gus", avatar:"ğŸ‘¦", need:"ğŸ’¡", role:"alumno", tags:["arte"], x:880,y:300},
      {id:"al2", name:"Lia", avatar:"ğŸ‘§", need:"ğŸ’¡", role:"alumno", tags:["arte"], x:660,y:320},
      {id:"al3", name:"Pili", avatar:"ğŸ‘§", need:"ğŸ’¡", role:"alumno", tags:["arte"], x:840,y:420},
      {id:"cumple2", name:"Niko", avatar:"ğŸ§‘", need:"âœ¨", role:"cumple", tags:["fiesta"], x:540,y:440},
      {id:"mus2", name:"DJ", avatar:"ğŸ§‘â€ğŸ¤", need:"ğŸ¸", role:"musica", tags:["fiesta"], x:640,y:560},
      {id:"pas2", name:"Chef", avatar:"ğŸ§‘â€ğŸ³", need:"ğŸ‚", role:"pastel", tags:["fiesta"], x:520,y:640},
      {id:"dec2", name:"Deco", avatar:"ğŸ§‘", need:"ğŸˆ", role:"deco", tags:["fiesta"], x:740,y:520}
    ],
    goals:[
      {id:"family2", type:"oneToOne", a:"ana2", b:"tia2", icon:"âœ‰ï¸", announce:"Familia conectada de nuevo."},
      {id:"game2", type:"oneToOne", a:"gamer1", b:"gamer2", icon:"ğŸ®", announce:"Â¡Partida lista!"},
      {id:"class2", type:"oneToMany", a:"profe2", bs:["al1","al2","al3"], icon:"ğŸ’¡", announce:"Clase creativa conectada."},
      {id:"party2", type:"manyToOne", bs:["mus2","pas2","dec2"], a:"cumple2", icon:"âœ¨", announce:"Â¡Fiesta activada!"}
    ]
  }
];

/*********************** ESTADO GLOBAL ************************/
let current = 0; // Ã­ndice de galaxia
let state = null; // estado de partida generado desde la galaxia
let selected = null; // planeta seleccionado (origen)
let completedConnections = 0; // conexiones logradas (para la barra global)
let totalConnections = 0; // total de conexiones requeridas
let album = JSON.parse(localStorage.getItem("album_conectado")||"[]");
let hintTimer = null;

/*********************** INICIALIZACIÃ“N ************************/
const $ = s=> document.querySelector(s);
const $$ = s=> [...document.querySelectorAll(s)];

const screens = { intro: $("#screenIntro"), game: $("#screenGame"), final: $("#screenFinal") };
const progressBar = $("#progressBar");
const progressText = $("#progressText");
const galaxyName = $("#galaxyName");
const linesSvg = $("#lines");
const mapa = $("#mapa");

$("#voiceToggle").addEventListener("change", e=> Narrator.setEnabled(e.target.checked));
$("#soundToggle").addEventListener("change", e=> AudioKit.setEnabled(e.target.checked));
$("#btnAlbum").addEventListener("click", showAlbum);

$("#btnStart").addEventListener("click", ()=>{
  startGame(0); // Empieza en Galaxia 1
});

$("#btnNarrarIntro").addEventListener("click", narrarIntro);
$("#btnReplay").addEventListener("click", ()=> startGame(current));
$("#btnNextGalaxy").addEventListener("click", ()=> startGame(Math.min(current+1, GALAXIES.length-1)));

function narrarIntro(){
  Narrator.speak("Bienvenidos al Observatorio CÃ³smico. AquÃ­ entenderÃ¡s que Internet es una red. Cuando conectas planetas, las ideas, los juegos y los mensajes pueden viajar. Tu misiÃ³n es escuchar las necesidades y conectar a quienes pueden ayudarse. Â¡Listo para despegar!");
}

/*********************** GENERACIÃ“N DE PARTIDA ************************/
function startGame(galaxyIndex){
  current = galaxyIndex;
  const g = GALAXIES[current];
  galaxyName.textContent = g.name;
  state = {
    nodes: JSON.parse(JSON.stringify(g.nodes)), // clonar
    goals: JSON.parse(JSON.stringify(g.goals)),
    made: { } // registro de enlaces por meta
  };
  selected = null;
  completedConnections = 0;
  // Cada meta cuenta como 1 paso para progreso, pero algunas son mÃºltiples conexiones.
  totalConnections = state.goals.length;
  updateProgress();
  // Render UI
  showScene("game");
  renderMap();
  Narrator.speak("Mapa estelar desplegado. Selecciona un planeta para ver su necesidad y busca con quiÃ©n conectarlo.");
  resetHintTimer();
}

function showScene(name){
  Object.values(screens).forEach(sc=> sc.classList.remove("active"));
  screens[name].classList.add("active");
}

/*********************** RENDER DEL MAPA ************************/
function renderMap(){
  // Limpiar lÃ­neas y planetas previos
  linesSvg.innerHTML = "";
  $$(".planeta").forEach(n=> n.remove());

  const g = GALAXIES[current];
  const {width, height} = g;
  linesSvg.setAttribute("viewBox", `0 0 ${width} ${height}`);

  // Crear planetas
  state.nodes.forEach(n=>{
    const el = document.createElement("button");
    el.className = "planeta";
    el.style.left = (n.x / width * 100) + "%";
    el.style.top  = (n.y / height * 100) + "%";
    el.setAttribute("aria-label", `${n.name}. Necesidad ${n.need}.`);
    el.dataset.id = n.id;
    el.innerHTML = `
      <div class="avatar" aria-hidden="true">${n.avatar}</div>
      <div class="name">${n.name}</div>
      <div class="need" title="Necesidad">${n.need}</div>
      <div class="meter" aria-hidden="true"><i></i></div>
    `;
    el.addEventListener("click", ()=> onPlanetClick(n.id));
    mapa.appendChild(el);
  });
}

/*********************** INTERACCIÃ“N DE CONEXIONES ************************/
function onPlanetClick(id){
  resetHintTimer();
  const node = state.nodes.find(n=> n.id===id);
  const btn = document.querySelector(`.planeta[data-id="${id}"]`);

  // Primer clic: seleccionar origen
  if(!selected){
    selected = node;
    highlightSelection();
    Narrator.speak(`${node.name} necesita ${node.need}. Busca con quiÃ©n conectarlo.`);
    return;
  }

  // Segundo clic: intentar conexiÃ³n
  if(selected.id === node.id){
    // DeselecciÃ³n
    selected = null; highlightSelection(); return;
  }

  const res = tryConnect(selected, node);
  if(res.ok){
    drawConnection(selected, node, res.goal.icon);
    bumpHappiness(selected.id);
    bumpHappiness(node.id);
    announceSuccess(res.goal);
    maybeCompleteGoal(res.goal);
    selected = null; highlightSelection();
  } else {
    AudioKit.softError();
    Narrator.speak("Ellos no buscan lo mismo, sigue buscando");
  }
}

function highlightSelection(){
  $$(".planeta").forEach(p=> p.classList.remove("selected"));
  if(selected){
    const b = document.querySelector(`.planeta[data-id="${selected.id}"]`);
    b && b.classList.add("selected");
  }
}

// Reglas de conexiÃ³n por meta
function tryConnect(a, b){
  for(const goal of state.goals){
    if(goal.done) continue;
    if(goal.type === "oneToOne"){ // 1 a 1: pares exactos a-b
      if((a.id===goal.a && b.id===goal.b) || (a.id===goal.b && b.id===goal.a)){
        goal.done = true; state.made[goal.id] = [[a.id,b.id]]; return {ok:true, goal};
      }
    }
    if(goal.type === "oneToMany"){ // a -> varios b
      if(a.id===goal.a && goal.bs.includes(b.id)){
        const arr = state.made[goal.id] || []; // pares realizados
        if(!arr.find(([x,y])=> y===b.id)){
          arr.push([a.id,b.id]); state.made[goal.id]=arr;
          if(arr.length===goal.bs.length) goal.done = true;
          return {ok:true, goal};
        }
      }
      if(b.id===goal.a && goal.bs.includes(a.id)){
        const arr = state.made[goal.id] || [];
        if(!arr.find(([x,y])=> y===a.id)){
          arr.push([b.id,a.id]); state.made[goal.id]=arr;
          if(arr.length===goal.bs.length) goal.done = true;
          return {ok:true, goal};
        }
      }
    }
    if(goal.type === "manyToOne"){ // varios -> a
      if((goal.bs.includes(a.id) && b.id===goal.a) || (goal.bs.includes(b.id) && a.id===goal.a)){
        const giver = goal.bs.includes(a.id)? a.id : b.id;
        const arr = state.made[goal.id] || [];
        if(!arr.find(([x,y])=> x===giver)){
          arr.push([giver, goal.a]); state.made[goal.id]=arr;
          if(arr.length===goal.bs.length) goal.done = true;
          return {ok:true, goal};
        }
      }
    }
  }
  return {ok:false};
}

/*********************** DIBUJO Y ANIMACIONES ************************/
function drawConnection(a, b, icon){
  const g = GALAXIES[current];
  const ax=a.x, ay=a.y, bx=b.x, by=b.y;
  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
  const id = `p${Math.random().toString(36).slice(2)}`;
  const mx = (ax+bx)/2 + (Math.random()*60-30);
  const my = (ay+by)/2 + (Math.random()*60-30);
  const d = `M ${ax} ${ay} Q ${mx} ${my} ${bx} ${by}`;
  path.setAttribute("d", d);
  path.setAttribute("fill", "none");
  path.setAttribute("stroke", "#7fe9ff");
  path.setAttribute("stroke-width", "3");
  path.setAttribute("stroke-linecap", "round");
  path.setAttribute("opacity", ".85");
  path.setAttribute("id", id);
  linesSvg.appendChild(path);

  // Animar icono viajando
  const mover = document.createElementNS("http://www.w3.org/2000/svg", "text");
  mover.textContent = icon;
  mover.setAttribute("font-size", "22");
  const animate = document.createElementNS("http://www.w3.org/2000/svg", "animateMotion");
  animate.setAttribute("dur", "1.6s");
  animate.setAttribute("repeatCount", "1");
  animate.setAttribute("fill", "freeze");
  const mpath = document.createElementNS("http://www.w3.org/2000/svg", "mpath");
  mpath.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href", `#${id}`);
  animate.appendChild(mpath); mover.appendChild(animate); linesSvg.appendChild(mover);
}

function bumpHappiness(id){
  const n = state.nodes.find(x=> x.id===id);
  n.happy = Math.min(1, (n.happy||0)+0.5);
  const meter = document.querySelector(`.planeta[data-id="${id}"] .meter i`);
  if(meter){ meter.style.width = (n.happy*100)+"%"; }
}

function announceSuccess(goal){
  AudioKit.chordSuccess();
  switch(goal.id){
    case "videollamada":
      Narrator.speak("Â¡ConexiÃ³n exitosa! Â¡Has hecho feliz a alguien! Familia: Â¡La red acorta la distancia, y nos une en la misma estancia!");
      break;
    case "gamers":
      Narrator.speak("Â¡ConexiÃ³n exitosa! Â¡Has hecho feliz a alguien! Jugadores: Â¡Con un simple clic, la diversiÃ³n hace un tic!");
      break;
    default:
      Narrator.speak("Â¡ConexiÃ³n exitosa! Â¡Has hecho feliz a alguien!");
  }
}

function maybeCompleteGoal(goal){
  if(goal.done){
    completedConnections++;
    updateProgress();
    // AnimaciÃ³n especial segÃºn meta
    if(goal.id === "videollamada") specialAnim("âœ‰ï¸");
    if(goal.id === "gamers") specialAnim("ğŸ®");
    if(goal.id === "clase") specialAnim("ğŸ’¡");
    if(goal.id === "fiesta") specialAnim("ğŸ‰");

    // Guardar en Ã¡lbum
    saveMoment(goal);

    // Â¿Victoria global?
    if(completedConnections>=totalConnections){
      setTimeout(()=> victory(), 700);
    }
  }
}

function updateProgress(){
  const pct = (completedConnections/Math.max(1,totalConnections))*100;
  progressBar.style.width = pct+"%";
  progressText.textContent = `${completedConnections}/${totalConnections}`;
}

function specialAnim(icon){
  // PequeÃ±o destello en el centro del mapa
  AudioKit.sparkle();
  const span = document.createElement("div");
  span.textContent = icon;
  span.style.position = "absolute";
  span.style.left = "50%"; span.style.top = "50%"; span.style.transform = "translate(-50%,-50%) scale(0.5)";
  span.style.fontSize = "56px"; span.style.filter = "drop-shadow(0 8px 16px rgba(0,0,0,.6))";
  mapa.appendChild(span);
  setTimeout(()=> span.style.transition = "transform .6s ease, opacity .6s ease", 0);
  setTimeout(()=>{ span.style.transform = "translate(-50%,-50%) scale(1.4)"; }, 0);
  setTimeout(()=>{ span.style.opacity = "0"; }, 530);
  setTimeout(()=> span.remove(), 1200);
}

/*********************** FINAL / VICTORIA ************************/
function victory(){
  showScene("final");
  // Render de red final (zoom out simulado)
  const div = $("#finalNet");
  div.innerHTML = "";
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("viewBox", linesSvg.getAttribute("viewBox"));
  svg.style.width = "100%"; svg.style.height = "100%";
  div.appendChild(svg);
  // Copiar paths existentes
  svg.innerHTML = linesSvg.innerHTML;
  // Brillo
  svg.querySelectorAll("path").forEach(p=>{
    p.setAttribute("stroke", "#b0fffb");
    p.setAttribute("stroke-width", "3");
  });
  Narrator.speak("Victoria. La red completa brilla uniendo corazones en toda la galaxia.");
}

/*********************** HINTS ************************/
function resetHintTimer(){
  clearTimeout(hintTimer);
  hintTimer = setTimeout(()=>{
    // Buscar primera meta no completa y sugerir
    const g = state.goals.find(x=> !x.done);
    if(!g) return;
    let ids = [];
    if(g.type==="oneToOne") ids=[g.a, g.b];
    if(g.type==="oneToMany") ids=[g.a, ...g.bs];
    if(g.type==="manyToOne") ids=[...g.bs, g.a];
    ids.forEach(id=>{
      const el = document.querySelector(`.planeta[data-id="${id}"]`);
      el && el.classList.add("hint");
      setTimeout(()=> el && el.classList.remove("hint"), 1200);
    });
    Narrator.speak("Pista de la GuÃ­a de la Galaxia: mira los planetas resaltados. Â¿QuiÃ©n puede ayudar a quiÃ©n?");
  }, 9000);
}

/*********************** ÃLBUM ************************/
function saveMoment(goal){
  const gname = GALAXIES[current].name;
  const stamp = {g:gname, id:goal.id, t:Date.now()};
  album.push(stamp);
  localStorage.setItem("album_conectado", JSON.stringify(album));
}
function showAlbum(){
  const items = JSON.parse(localStorage.getItem("album_conectado")||"[]");
  const pretty = items.map(x=> `${new Date(x.t).toLocaleString()} â€” ${x.g} â€” ${x.id}`).join("\n");
  alert(items.length? `ğŸ“¸ Ãlbum de Momentos Conectados:\n\n${pretty}` : "AÃºn no hay momentos guardados. Â¡Conecta para coleccionar!");
}

/*********************** DEMO INTRO (animaciÃ³n) ************************/
(function demoAnim(){
  const svg = $("#demoSvg");
  const lines = svg.querySelector("#demoLines");
  const flow = svg.querySelectorAll("#demoFlow text");
  let i=0;
  setInterval(()=>{
    // Dibuja una lÃ­nea aleatoria entre puntos
    const pts = [
      [100,70],[250,120],[420,80],[160,280],[520,260]
    ];
    const a = pts[(i)%pts.length];
    const b = pts[(i+2)%pts.length];
    const p = document.createElementNS("http://www.w3.org/2000/svg", "line");
    p.setAttribute("x1", a[0]); p.setAttribute("y1", a[1]); p.setAttribute("x2", b[0]); p.setAttribute("y2", b[1]);
    p.setAttribute("stroke", "#7fe9ff"); p.setAttribute("stroke-width", "3"); p.setAttribute("opacity", ".65");
    p.setAttribute("filter", "url(#glow)");
    lines.appendChild(p);
    const t = flow[i%flow.length];
    t.setAttribute("x", a[0]); t.setAttribute("y", a[1]);
    t.animate([{transform:"translate(0,0)"},{transform:`translate(${b[0]-a[0]}px, ${b[1]-a[1]}px)`}], {duration:1700, fill:"forwards"});
    i++;
    if(i>9){ lines.innerHTML=""; i=0; }
  }, 900);
})();

// NarraciÃ³n inicial automÃ¡tica breve
setTimeout(()=> Narrator.speak("Observatorio listo. Pulsa Comenzar MisiÃ³n para ir al mapa estelar."), 800);
</script>
</body>
</html>
